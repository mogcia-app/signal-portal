# 請求書ページ（/invoice）実装詳細

## 概要

請求書支払いを選択したユーザー向けの請求書管理ページ。**フロントエンドは表示専用**で、請求書の生成は100%サーバー側（Cron/API）で行う。

## 設計思想（重要）

### 責務分離の原則

**❌ フロントエンドで請求書を生成しない**
- ページ表示時に自動生成しようとすると、以下の問題が発生：
  - ユーザーがその日にログインしなかったら請求書が発行されない
  - 複数回生成の競合（ページ再読み込み、useEffect が2回走る、通信遅延）
  - タイムゾーンや日付文字列の扱いがクライアント依存

**✅ 正しい責務分離**

#### フロントエンド（/invoice）
- Authチェック
- 「請求書支払いユーザーか」の判定
- `invoices`コレクションの一覧表示
- PDF出力
- 次回請求日の表示（生成されていない場合）

👉 **生成ロジックは一切持たない**

#### バックエンド（API Routes）
- 月次自動生成（Cron経由）
- デモ・手動生成（管理者用）
- 重複防止（`billingMonth`フィールド）

👉 **生成は100%サーバー側**

## アクセス制御

### 認証要件
- `AuthGuard`でラップされ、ログイン必須
- ログインしていないユーザーは`/`（ログインページ）にリダイレクト

### 支払方法チェック
- `contractData.paymentMethods`に"請求書発行"が含まれているユーザーのみアクセス可能
- 請求書支払いを選択していないユーザーにはアクセス拒否メッセージを表示

## 主要機能

### 1. 請求書一覧表示

#### 表示内容
- 請求書番号
- 請求日
- 支払期限
- 金額（合計）
- ステータス（支払い済み / 支払い待ち / 支払い期限切れ）
- 操作ボタン（表示 / PDF）

#### ソート
- `invoiceDate`の降順（新しい順）

#### 次回請求日の表示
- 今月分の請求書がまだ生成されていない場合、「次回請求日: ◯月◯日」を表示
- 「生成されていない＝異常」ではなく、「次回生成待ち」として表示

### 2. 請求書詳細表示

#### 表示される情報

**請求先（契約書ページで設定した情報）**
- 会社名 + "御中"
- 住所
- 代表者名
- 電話番号（存在する場合）
- メールアドレス（存在する場合）
- 支払日（「毎月15日支払」または「毎月30日支払」）

**発行元（固定情報）**
- 会社名: 株式会社MOGCIA
- 住所: 〒810-0001 福岡県福岡市中央区天神4丁目6-28 いちご天神ノースビル7階
- 登録番号: T1290001103697
- ロゴ画像: `/mogcia-invoice.png`

**明細**
- プラン名 + "月額利用料"
- 数量: 1
- 単価: プラン価格
- 金額: プラン価格

**合計**
- 小計: プラン価格
- 消費税 (10%): 小計 × 0.1（切り捨て）
- 合計: 小計 + 消費税

**お振込先（固定情報）**
- 銀行: 佐賀銀行福岡支店 (普通) 3078446
- 口座名義: 株式会社MOGCIA

### 3. PDF出力機能

#### 実装
- `jsPDF`と`html2canvas`を使用
- 請求書詳細表示部分を画像化してPDFに変換
- ファイル名: `請求書_{invoiceNumber}.pdf`

## API Routes

### `/api/invoices/generate-monthly`（本命）

#### 用途
毎月の請求書自動生成（Cron Job用）

#### 認証
- `CRON_SECRET`による認証
- `Authorization: Bearer ${CRON_SECRET}`ヘッダーが必要

#### 処理フロー
1. 請求書支払いユーザー全員を取得
2. 各ユーザーについて：
   - 契約日の日にちを抽出
   - **契約日を過ぎていて、まだ今月分が無いなら作る**（Cron失敗や手動再実行にも対応）
   - プランIDを取得（`planTier` + `monthlyFee`の組み合わせを最優先）
   - `billingMonth`で重複チェック（既に存在する場合はスキップ）
   - 請求日を設定（契約日の日にち、ただし月末超え防止: `Math.min(contractDay, lastDayOfMonth)`）
   - 支払期限を計算（支払日に基づく）
   - 請求書をFirestoreに保存
   - 通知を作成

#### 重複防止
- `billingMonth`フィールド（例: "2026-02"）を使用
- クエリ: `where("userId", "==", userId).where("billingMonth", "==", billingMonth)`
- これにより、二重生成、再実行、Cronの多重実行を防ぐ

### `/api/invoices/create-demo`

#### 用途
デモ請求書の手動作成（管理者・開発用）

#### 認証
- なし（クライアント側から呼び出し）

#### 処理
- 指定されたユーザーに対して請求書を生成
- 支払期限の計算ロジックは自動生成と同じ
- 通知も自動生成される
- `billingMonth`フィールドも設定

## データフロー

### 1. ページ読み込み時（フロントエンド）
```
1. ユーザーデータを取得（Firestore）
2. contractDataを取得
3. 請求書支払いユーザーかチェック
4. 請求書一覧を取得（Firestore）
5. 次回請求日を計算・表示（今月分が存在しない場合）
```

### 2. 請求書生成時（バックエンド - Cron）
```
1. 請求書支払いユーザー全員を取得
2. 各ユーザーについて：
   a. 契約日の日にちを抽出
   b. 契約日を過ぎていて、まだ今月分が無いかチェック（Cron失敗や手動再実行にも対応）
   c. billingMonthで重複チェック
   d. プランIDを取得
   e. 請求日を設定（契約日の日にち、ただし月末超え防止）
   f. 支払期限を計算（支払日に基づく）
   g. 請求書をFirestoreに保存
   h. 通知をFirestoreに保存
```

## プラン定義

```typescript
const plans = {
  light: { 
    name: "ライト", 
    price: 15000,
    description: "..."
  },
  standard: { 
    name: "スタンダード", 
    price: 30000,
    description: "..."
  },
  professional: {
    name: "プロ",
    price: 60000,
    description: "..."
  },
};
```

## プランIDの取得優先順位

1. `planTier` + `monthlyFee`の組み合わせ
   - `ume` + 15000円 → `light`
   - `take` + 30000円 → `standard`
   - `matsu` + 60000円 → `professional`
2. `monthlyFee`のみ
   - 15000円 → `light`
   - 30000円 → `standard`
   - 60000円 → `professional`
3. `billingInfo.plan`
4. `selectedPlanId`
5. デフォルト: `light`

## 支払期限の計算

契約書ページで設定した支払日に基づいて計算：

- **「毎月15日支払」の場合**：
  - 請求日の月の15日を支払期限とする
  - 例：請求日が2月22日の場合、支払期限は2月15日

- **「毎月30日支払」の場合**：
  - 請求日の月の末日（28日、29日、30日、31日）を支払期限とする
  - 例：請求日が2月22日の場合、支払期限は2月28日（2月の末日）
  - 例：請求日が1月22日の場合、支払期限は1月31日（1月の末日）

### 計算例

#### 例1: 「毎月15日支払」の場合
- 契約日: 2026年1月22日
- 2月の請求書:
  - 発行日: 2026-02-22（契約日の日にち）
  - 支払期限: 2026-02-15（2月の15日）

#### 例2: 「毎月30日支払」の場合
- 契約日: 2026年1月22日
- 2月の請求書:
  - 発行日: 2026-02-22（契約日の日にち）
  - 支払期限: 2026-02-28（2月の末日）
- 1月の請求書:
  - 発行日: 2026-01-22（契約日の日にち）
  - 支払期限: 2026-01-31（1月の末日）

## Firestore構造

### `invoices`コレクション
```typescript
{
  userId: string;
  invoiceNumber: string; // "INV-YYYYMM-{userIdの最初6文字}"形式（deterministic: 再生成しても番号がブレない）
  invoiceDate: string; // "YYYY-MM-DD"形式（月末超え防止済み）
  dueDate: string; // "YYYY-MM-DD"形式
  planId: string;
  monthlyFee: number;
  subtotal: number;
  tax: number;
  total: number;
  status: 'pending' | 'paid' | 'overdue';
  billingMonth: string; // 重複防止用（例: "2026-02"）
  createdAt: Timestamp;
  paidAt?: Timestamp;
}
```

### セキュリティルール
- ユーザーは自分の請求書のみ読み取り可能
- 書き込みはAPI route経由のみ（クライアント側からの直接書き込みは不可）

## 重複防止の仕組み

### `billingMonth`フィールド

**必須フィールド**: `billingMonth: "2026-02"`形式

**用途**:
- 同一ユーザー・同一月の請求書が複数生成されることを防ぐ
- Cronの多重実行、ページ再読み込み、useEffectの重複実行など、あらゆる重複を防ぐ

**クエリ例**:
```typescript
where("userId", "==", userId)
where("billingMonth", "==", "2026-02")
```

**生成タイミング**:
- 請求書作成時に必ず設定
- 形式: `${year}-${String(month + 1).padStart(2, '0')}`

## 注意事項

1. **請求書の生成はサーバー側のみ**
   - フロントエンドから生成ロジックを呼び出さない
   - ページ表示時に自動生成しない

2. **契約日の判定ロジック**
   - 「今日が契約日」ではなく「契約日を過ぎていて、まだ今月分が無いなら作る」
   - これにより、Cron失敗や手動再実行にも対応可能

3. **請求日の月末超え防止**
   - 契約日が31日で2月の場合、自動的に2月の末日（28日/29日）に調整
   - 実装: `invoiceDay = Math.min(contractDay, lastDayOfMonth)`

4. **請求書番号の設計（deterministic）**
   - 形式: `INV-YYYYMM-{userIdの最初6文字}`
   - 再生成しても番号がブレないため、会計・監査対応が容易
   - 将来的には `INV-{billingMonth}-{sequence}` 形式への変更も可能

5. **支払期限の計算**
   - 「毎月30日支払」の場合、月の末日を正確に計算（うるう年も考慮）

6. **プランIDの取得**
   - Admin側で変更されたプランを反映するため、`planTier`と`monthlyFee`の組み合わせを最優先

7. **契約書データの取得**
   - `contractData`はネストされている可能性があるため、`contractData.contractData`または`contractData`から取得

8. **Cron設定**
   - `/api/invoices/generate-monthly`を毎日実行（例: 00:05）
   - Vercel Cron Jobsまたは外部Cronサービスを使用

9. **Admin claim チェック（将来実装）**
   - `/api/invoices/create-demo`にAdmin claim チェックを追加予定（TODOコメントあり）

## 今後の改善点

1. 請求書のステータス更新機能（支払い済みにマーク）
2. 請求書の編集機能（管理者向け）
3. 請求書の一括ダウンロード機能
4. 請求書の検索・フィルタリング機能
5. 請求書の再発行機能（管理者向け）

## まとめ（超重要ポイント）

- ✅ 設計思想は正しい（Authで守って、契約書データを唯一の正として、そこから全部引っ張る）
- ✅ 請求書生成は100%サーバー責務
- ✅ フロントエンドは表示専用
- ✅ `billingMonth`を必ず持たせる（重複防止）
- ✅ Cron + 同一ロジック関数化が最強
- ✅ 契約日の判定を改善（「契約日を過ぎていて、まだ今月分が無い」→ Cron失敗や手動再実行にも対応）
- ✅ 請求日の月末超え防止（`Math.min(contractDay, lastDayOfMonth)`）
- ✅ 請求書番号を deterministic に（再生成しても番号がブレない）
