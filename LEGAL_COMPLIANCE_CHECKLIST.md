# 契約書関係の法的コンプライアンスチェックリスト

## ✅ 現在実装済みの対策

### 1. サーバー側での記録
- ✅ サーバー側タイムスタンプ（`serverTimestamp()`）による改ざん不可の日時記録
- ✅ IPアドレスの記録
- ✅ User-Agentの記録
- ✅ APIルーター経由での保存（クライアント側からの直接書き込みを防止）

### 2. 監査証跡
- ✅ `agreementHistory`コレクションへの履歴保存
- ✅ 同意タイプ、日時、IPアドレス、User-Agent、ユーザーIDの記録

### 3. データ保護
- ✅ 既に保存済みのデータの上書き防止（サーバー側でのチェック）
- ✅ クライアント側でのUI保護（保存済みの場合は入力フィールド無効化）

### 4. 認証
- ✅ すべての同意ページでAuth認証必須
- ✅ ユーザーIDによる記録

## ⚠️ 追加で実装すべき対策（推奨）

### 1. 規約のバージョン管理（重要度: 高）
**問題**: 規約が変更された場合、どのバージョンに同意したかが不明確
**対策**: 
- 規約のバージョン番号を定義（例: `privacyPolicyVersion: "1.0"`）
- 同意時にバージョン番号を記録
- 規約変更時はバージョン番号を更新し、既存ユーザーには再同意を求める

### 2. 同意内容の全文保存（重要度: 高）
**問題**: 規約が変更されても、同意した時点の規約内容が記録されていない
**対策**:
- 同意時に表示されていた規約の全文をハッシュ化して保存
- または、規約の全文をFirestore Storageに保存

### 3. PDFとしての保存（重要度: 中）
**問題**: 画面表示のみでは、後から改ざんの可能性がある
**対策**:
- 同意時の画面をPDFとして生成し、Firestore Storageに保存
- PDFにはタイムスタンプとユーザー情報を含める

### 4. ハッシュ値の保存（重要度: 中）
**問題**: データの改ざんを検知できない
**対策**:
- 同意内容のハッシュ値（SHA-256など）を計算して保存
- 定期的にハッシュ値を検証して改ざんを検知

### 5. データのバックアップ（重要度: 高）
**問題**: Firestoreのデータが消失した場合のリスク
**対策**:
- 定期的なFirestoreのバックアップ設定
- 重要な同意データは別システム（例: Cloud Storage）にも保存

### 6. ログの完全性保証（重要度: 中）
**問題**: ログの改ざんを検知できない
**対策**:
- ログのハッシュチェーンを実装
- または、信頼できるタイムスタンプサービス（TSA）の利用

### 7. 電子署名の実装（重要度: 低-中）
**問題**: より強固な法的証拠が必要な場合
**対策**:
- 電子署名サービス（例: DocuSign、Adobe Sign）との統合
- または、公開鍵暗号方式による署名の実装

### 8. 同意画面のスクリーンショット保存（重要度: 低）
**問題**: ユーザーがどの画面を見て同意したかの証拠
**対策**:
- 同意時の画面を自動的にスクリーンショットとして保存
- Firestore Storageに保存

## 📋 実装優先順位

### 最優先（法的トラブル時に必須）
1. **規約のバージョン管理** - 規約変更時の法的問題を防ぐ
2. **同意内容の全文保存** - 同意した時点の規約内容を記録
3. **データのバックアップ** - データ消失リスクの軽減

### 次優先（証拠能力の強化）
4. **PDFとしての保存** - 改ざん防止の証拠
5. **ハッシュ値の保存** - 改ざん検知

### オプション（より強固な証拠が必要な場合）
6. **電子署名の実装**
7. **ログの完全性保証**
8. **同意画面のスクリーンショット保存**

## 🔍 現在の実装でカバーできる範囲

現在の実装で以下の点は法的証拠として有効です：
- ✅ サーバー側タイムスタンプによる日時記録
- ✅ IPアドレスとUser-Agentによるアクセス記録
- ✅ 監査証跡による履歴管理
- ✅ 上書き防止によるデータ保護

ただし、規約変更時のバージョン管理と同意内容の全文保存は追加実装を推奨します。

